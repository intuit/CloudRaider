<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AvailabilityZoneStepDefinitions.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cloudraider-core</a> &gt; <a href="index.source.html" class="el_package">com.intuit.cloudraider.cucumber.steps</a> &gt; <span class="el_source">AvailabilityZoneStepDefinitions.java</span></div><h1>AvailabilityZoneStepDefinitions.java</h1><pre class="source lang-java linenums">/*
 * Apache 2.0 License
 *
 * Copyright (c) 2019 Intuit Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

package com.intuit.cloudraider.cucumber.steps;

import com.amazonaws.services.ec2.model.Tag;
import com.intuit.cloudraider.core.interfaces.EC2Raider;
import com.intuit.cloudraider.cucumber.model.ExecutionStateCache;
import com.intuit.cloudraider.cucumber.util.CucumberHelperFunctions;
import com.intuit.cloudraider.model.EC2InstanceTO;
import cucumber.api.java.en.Given;
import cucumber.api.java.en.Then;
import cucumber.api.java.en.When;
import org.junit.Assert;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

/**
 * Cucumber Step Definitions for filtering EC2 instances based in a certain availability zone.
 */
public class AvailabilityZoneStepDefinitions {

    @Autowired
    @Qualifier(&quot;ec2raiderBean&quot;)
    private EC2Raider ec2Raider;

    /**
     * The Logger.
     */
<span class="nc" id="L59">    Logger logger = LoggerFactory.getLogger(this.getClass());</span>

    public ExecutionStateCache getExecutionStateCache() {
<span class="nc" id="L62">        return executionStateCache;</span>
    }

    public void setExecutionStateCache(ExecutionStateCache executionStateCache) {
<span class="nc" id="L66">        this.executionStateCache = executionStateCache;</span>
<span class="nc" id="L67">    }</span>

    @Autowired
    private ExecutionStateCache executionStateCache;

<span class="nc" id="L72">    public AvailabilityZoneStepDefinitions() {</span>

<span class="nc" id="L74">    }</span>

    /**
     * Finds all instances in given availability zones that do not match any of the tags provided.
     *
     * @param azs availability zones (i.e. us-west-2a)
     * @param instanceIgnoreTags tags to ignore; tags are in the form of tagName:tagValue,tagName:tagValue
     * @return AvailabilityZoneStepDefinitions
     */
    @Given(&quot;^AZs \&quot;([^\&quot;]*)\&quot; ignore instances with tags \&quot;([^\&quot;]*)\&quot;$&quot;)
    public AvailabilityZoneStepDefinitions givenAzWithIgnoreTags(String azs, String instanceIgnoreTags) {
<span class="nc" id="L85">        String[] availabilityZones = azs.split(&quot;,\\s*&quot;);</span>

<span class="nc" id="L87">        List&lt;Tag&gt; tags = CucumberHelperFunctions.tagStringToList(instanceIgnoreTags);</span>

<span class="nc" id="L89">        List&lt;String&gt; instanceIdsToIgnore =</span>
<span class="nc" id="L90">                new ArrayList&lt;&gt;(ec2Raider.getInstancesFromAnyTags(tags).stream().map(EC2InstanceTO::getInstanceId).collect(Collectors.toList()));</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">        for (String availabilityZone : availabilityZones) {</span>
<span class="nc" id="L93">            executionStateCache.addInstances(ec2Raider.getEc2InstancesForAvailabilityZone(availabilityZone, instanceIdsToIgnore));</span>
        }
<span class="nc" id="L95">        return this;</span>
    }
    
    /**
     * Finds all instances in given availability zones that do not match any of the tags to ignore and matches ALL of the
     * compulsory tags.
     *
     * @param azs availability zones (i.e. us-west-2a)
     * @param compulsoryTagsString tags that must be present; tags are in the form of tagName:tagValue,tagName:tagValue
     * @param ignoreTagsString tags to ignore; tags are in the form of tagName:tagValue,tagName:tagValue
     */
    @Given(&quot;^AZs \&quot;([^\&quot;]*)\&quot; instance only with tags \&quot;([^\&quot;]*)\&quot; ignore instances with tags \&quot;([^\&quot;]*)\&quot;$&quot;)
    public void givenAzWithCompulsoryTags(String azs, String compulsoryTagsString, String ignoreTagsString) {
<span class="nc" id="L108">        String[] availabilityZones = azs.split(&quot;,\\s*&quot;);</span>

<span class="nc" id="L110">        List&lt;Tag&gt; compulsoryTags = CucumberHelperFunctions.tagStringToList(compulsoryTagsString);</span>
<span class="nc" id="L111">        List&lt;Tag&gt; ignoreTags = CucumberHelperFunctions.tagStringToList(ignoreTagsString);</span>

<span class="nc" id="L113">        List&lt;EC2InstanceTO&gt; instances = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">        for (String availabilityZone : availabilityZones) {</span>
<span class="nc" id="L116">            instances.addAll(ec2Raider.getEc2InstanceIdsWithCompulsoryTagsForAvailabilityZone(availabilityZone, ignoreTags, compulsoryTags));</span>
        }

<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (instances.isEmpty()) {</span>
<span class="nc" id="L120">            throw new RuntimeException(&quot;No instances available&quot;);</span>
        }
<span class="nc" id="L122">        executionStateCache.setInstances(instances);</span>
<span class="nc" id="L123">    }</span>


    @When(&quot;^terminate (\\d+) instance in AZ$&quot;)
    public AvailabilityZoneStepDefinitions terminateInstanceOnNumInstances(int numInstances )
    {
<span class="nc" id="L129">        List&lt;EC2InstanceTO&gt; instances = executionStateCache.getInstances();</span>

<span class="nc bnc" id="L131" title="All 4 branches missed.">        if (instances == null  || instances.isEmpty())</span>
        {
<span class="nc" id="L133">            throw new RuntimeException(&quot;Unable to terminate process, no instances available in AZ&quot;);</span>
        }

<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (numInstances &gt; instances.size())</span>
        {
<span class="nc" id="L138">            numInstances = instances.size();</span>
        }

        //Added to include randomness
<span class="nc" id="L142">        Collections.shuffle(instances);</span>

<span class="nc" id="L144">        IntStream.range(0, numInstances )</span>
<span class="nc" id="L145">                .parallel()</span>
<span class="nc" id="L146">                .forEach(</span>
                        i -&gt;
                        {
<span class="nc" id="L149">                            logger.info(&quot;AZ Terminated Instance : &quot;);</span>
<span class="nc" id="L150">                            logger.info(instances.get(i).getInstanceId());</span>
<span class="nc" id="L151">                            ec2Raider.terminateEc2InstancesById(instances.get(i).getInstanceId());</span>
<span class="nc" id="L152">                        } );</span>

<span class="nc" id="L154">        return this;</span>
    }

    @When(&quot;^terminate (\\d+) instance in AZ only with tags \\\&quot;([^\\\&quot;]*)\\\&quot;$&quot;)
    public AvailabilityZoneStepDefinitions terminateInstanceOnNumInstancesWithTags(int numInstances, String compulsoryTagsString)
    {
<span class="nc" id="L160">        List&lt;Tag&gt; compulsoryTags = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L161">        List&lt;Tag&gt; currentTags = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L163">        String[] compulsoryTagKeyValuePairs = compulsoryTagsString.split(&quot;; &quot;);</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">        for (String compulsoryTagKeyValuePair : compulsoryTagKeyValuePairs) {</span>
<span class="nc" id="L166">            String[] compulsoryTagKeyValue = compulsoryTagKeyValuePair.split(&quot;=&quot;);</span>
<span class="nc" id="L167">            Tag compulsoryTag = new Tag();</span>

<span class="nc" id="L169">            compulsoryTag.setKey(compulsoryTagKeyValue[0]);</span>
<span class="nc" id="L170">            compulsoryTag.setValue(compulsoryTagKeyValue[1]);</span>
<span class="nc" id="L171">            compulsoryTags.add(compulsoryTag);</span>
        }

<span class="nc" id="L174">        List&lt;EC2InstanceTO&gt; instances = executionStateCache.getInstances();</span>

<span class="nc bnc" id="L176" title="All 4 branches missed.">        if (instances == null  || instances.isEmpty())</span>
        {
<span class="nc" id="L178">            throw new RuntimeException(&quot;Unable to terminate process, no instances available in AZ&quot;);</span>
        }

<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (numInstances &gt; instances.size())</span>
        {
<span class="nc" id="L183">            numInstances = instances.size();</span>
        }

        //Added to include randomness
<span class="nc" id="L187">        Collections.shuffle(instances);</span>

<span class="nc" id="L189">        int terminatedInstances = 0;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        for ( EC2InstanceTO instance : instances) {</span>
<span class="nc" id="L191">            boolean flag = true;</span>

<span class="nc bnc" id="L193" title="All 2 branches missed.">            for(Tag compulsoryTag : compulsoryTags) {</span>
<span class="nc" id="L194">                boolean instanceContainsTag = false;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                for(Tag instanceTag : instance.getTags()) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                    if(instanceTag.equals(compulsoryTag)) {</span>
<span class="nc" id="L197">                        instanceContainsTag = true;</span>
<span class="nc" id="L198">                        break;</span>
                    }
<span class="nc" id="L200">                }</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                if(!instanceContainsTag) {</span>
<span class="nc" id="L202">                    flag = false;</span>
<span class="nc" id="L203">                    break;</span>
                }
<span class="nc" id="L205">            }</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">            if(flag) {</span>
<span class="nc" id="L208">                logger.info(&quot;Terminated Instance: &quot; +instance.getInstanceId());</span>
<span class="nc" id="L209">                ec2Raider.terminateEc2InstancesById(instance.getInstanceId());</span>

<span class="nc" id="L211">                terminatedInstances += 1;</span>
            }

<span class="nc bnc" id="L214" title="All 2 branches missed.">            if(terminatedInstances == numInstances) {</span>
<span class="nc" id="L215">                break;</span>
            }

<span class="nc" id="L218">        }</span>
<span class="nc" id="L219">        return this;</span>
    }

    List&lt;Tag&gt; tagStringToList(String tagString) {
<span class="nc" id="L223">        List&lt;Tag&gt; tags = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L225" title="All 4 branches missed.">        if(tagString == null || tagString.equals(&quot;&quot;)) {</span>
<span class="nc" id="L226">            return tags;</span>
        }

<span class="nc" id="L229">        String[] tagKeyValuePairs = tagString.split(&quot;; &quot;);</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">        for (String tagKeyValuePair : tagKeyValuePairs) {</span>
<span class="nc" id="L232">            String[] tagKeyValue = tagKeyValuePair.split(&quot;=&quot;);</span>
<span class="nc" id="L233">            Tag tag = new Tag();</span>
<span class="nc" id="L234">            tag.setKey(tagKeyValue[0]);</span>
<span class="nc" id="L235">            tag.setValue(tagKeyValue[1]);</span>
<span class="nc" id="L236">            tags.add(tag);</span>
        }

<span class="nc" id="L239">        return tags;</span>
    }

    @Then(&quot;^assertEC2 healthy host count in AZ$&quot;)
    public void confirmHealthyHostCount() throws Throwable
    {
<span class="nc" id="L245">        String[] availaibilityzones = executionStateCache.getAvailaibilityzones();</span>
<span class="nc" id="L246">        List&lt;Tag&gt; compulsoryTags = executionStateCache.getCompulsoryTags();</span>
<span class="nc" id="L247">        List&lt;Tag&gt; ignoreTags = executionStateCache.getIgnoreTags();</span>

<span class="nc" id="L249">        List&lt;EC2InstanceTO&gt; instances = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">        for(String availaibilityzone : availaibilityzones) {</span>
<span class="nc" id="L252">            instances.addAll(ec2Raider.getEc2InstanceIdsWithCompulsoryTagsForAvailabilityZone(availaibilityzone,ignoreTags,compulsoryTags));</span>
        }
<span class="nc" id="L254">        logger.info(&quot;AZ healthy host count : &quot; + instances.size());</span>
<span class="nc" id="L255">        Assert.assertTrue (&quot;Healthy host count mismatched &quot; ,this.confirmHealthyHostCount(instances.size()));</span>
<span class="nc" id="L256">    }</span>

    public boolean confirmHealthyHostCount(int expected) throws Throwable
    {
<span class="nc bnc" id="L260" title="All 2 branches missed.">        return (executionStateCache.getHealthyHostCount() == expected);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>